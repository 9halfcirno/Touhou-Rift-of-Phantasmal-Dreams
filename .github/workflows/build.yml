name: Build H5 Game (WORKING FIX)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:

  build-exe:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Neutralinojs
        shell: cmd
        run: npm install -g @neutralinojs/neu

      - name: Create wrapper
        shell: cmd
        run: neu create wrapper

      - name: Copy game files
        shell: cmd
        run: |
          robocopy . wrapper\resources /E /XD wrapper .git .github node_modules
          exit 0

      - name: Create index.html
        shell: cmd
        run: copy wrapper\resources\main.html wrapper\resources\index.html

      - name: Build EXE
        shell: cmd
        run: |
          cd wrapper
          neu build --release

      - uses: actions/upload-artifact@v4
        with:
          name: game-exe
          path: wrapper/dist/windows/*.exe



    build-apk:
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4

        # ✅ 强制安装 Java 17
        - name: Setup Java 17
          uses: actions/setup-java@v4
          with:
            distribution: temurin
            java-version: 17

        # ✅ 确认 Java 版本
        - name: Verify Java
          run: |
            java -version
            echo "JAVA_HOME=$JAVA_HOME"

        - name: Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: 20

        # ✅ 准备 web 文件
        - name: Prepare web dir
          run: |
            mkdir web
              rsync -av \
              --exclude=".git" \
              --exclude=".github" \
              --exclude="node_modules" \
              --exclude="android" \
              ./ web/

            cp web/main.html web/index.html

        # ✅ 安装 Capacitor
        - name: Install Capacitor
          run: |
            npm install @capacitor/core
            npm install @capacitor/cli
            npm install @capacitor/android

        # ✅ 初始化
        - name: Init Capacitor
          run: |
            npx cap init Game com.example.game --web-dir web

        - name: Add Android
          run: |
            npx cap add android

        # ✅ 强制 Gradle 使用 Java 17（关键修复）
        - name: Fix Java compatibility
          run: |
            echo "org.gradle.java.home=$JAVA_HOME" >> android/gradle.properties

            sed -i 's/sourceCompatibility = JavaVersion.VERSION_21/sourceCompatibility = JavaVersion.VERSION_17/g' android/**/*.gradle || true
            sed -i 's/targetCompatibility = JavaVersion.VERSION_21/targetCompatibility = JavaVersion.VERSION_17/g' android/**/*.gradle || true

        - name: Sync
          run: |
            npx cap sync android

        # ✅ 构建 APK
        - name: Build APK
          run: |
            cd android
            chmod +x gradlew
            ./gradlew assembleRelease \
              -Dorg.gradle.java.home=$JAVA_HOME \
              --no-daemon

        - uses: actions/upload-artifact@v4
          with:
            name: game-apk
            path: android/app/build/outputs/apk/release/*.apk
